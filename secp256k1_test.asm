	ORG	0x8000
START:	JP	TMODMUL
	JP	TMODINV
	JP	TECDOUB
; Tests 256 bit modular multiplication
; In: XVALUE, YVALUE: little-endian 256 bit multiplicands, EXPECT: little-endian 256 bit expected product
; Out: B = 0 if test passed, length of erroneous prefix (LSB) otherwise
TMODMUL:LD	HL,PRODUCT
	EXX
	PUSH	HL
	LD	HL,XVALUE
	LD	DE,YVALUE
	CALL	MODMUL
	LD	HL,PRODUCT + 0x1F
	CALL	MODCAN
	EXX
	POP	HL
	EXX
	LD	DE,EXPECT + 0x20
	LD	BC,0x2000
CHECK:	DEC	DE
	DEC	HL
	LD	A,(DE)
	CP	(HL)
	RET	NZ
	DJNZ	CHECK
	RET
; Tests 256 bit modular inverse
; In: XVALUE: value to invert
; Out: BC = 0 if test passed
TMODINV:LD	HL,XVALUE
	LD	DE,XINV
	CALL	MODINV
	LD	HL,PRODUCT
	EXX
	PUSH	HL
	LD	HL,XVALUE
	LD	DE,XINV
	CALL	MODMUL
	EXX
	POP	HL
	EXX
	DEC	HL
	LD	A,(HL)
	INC	A
	JR	NZ,CHECKL
	LD	HL,PRODUCT
	CALL	MODSUBP
	DEC	HL
CHECKL:	LD	BC,0x1F00
CHECKI:	LD	A,(HL)
	DEC	HL
	CP	C
	RET	NZ
	DJNZ	CHECKI
	INC	C
	DEC	(HL)
	RET	NZ
	DEC	C
	RET
; Tests doubling of generator point on EC
TECDOUB:EXX
	PUSH	HL
	LD	HL,ECGX
	CALL	ECDOUB
	POP	HL
	EXX
	LD	BC,0
	RET
	INCLUDE	"secp256k1.asm"
	INCLUDE "bigmul.asm"
	INCLUDE "mul8bit.asm"
	INCLUDE "multab.asm"

XVALUE:	DEFB	0x70, 0xA9, 0x21, 0xF6
	DEFB	0x1F, 0xA1, 0x8F, 0x38
	DEFB	0x33, 0xA8, 0x0A, 0x4D
	DEFB	0x91, 0x68, 0x2F, 0xFA
	DEFB	0x51, 0x11, 0x22, 0x1C
	DEFB	0xF8, 0xF7, 0x49, 0xBB
	DEFB	0xCA, 0x88, 0x47, 0x4D
	DEFB	0xEE, 0xB4, 0x75, 0x90

YVALUE:	DEFB	0xA6, 0xA6, 0x67, 0x97
	DEFB	0xEC, 0xAE, 0xBE, 0x0F
	DEFB	0x34, 0x3D, 0xDC, 0x53
	DEFB	0x23, 0x60, 0x55, 0xC1
	DEFB	0x6A, 0xA4, 0xF0, 0xC5
	DEFB	0x11, 0x90, 0xE7, 0x4D
	DEFB	0x31, 0x4D, 0xD7, 0x4E
	DEFB	0x06, 0x1A, 0xE3, 0xB7

EXPECT:	DEFB	0x01, 0x00, 0x00, 0x00
	DEFB	0x00, 0x00, 0x00, 0x00
	DEFB	0x00, 0x00, 0x00, 0x00
	DEFB	0x00, 0x00, 0x00, 0x00
	DEFB	0x00, 0x00, 0x00, 0x00
	DEFB	0x00, 0x00, 0x00, 0x00
	DEFB	0x00, 0x00, 0x00, 0x00
	DEFB	0x00, 0x00, 0x00, 0x00

XINV:	DEFS	0x20
MODINVU:DEFS	0x22
MODINVV:DEFS	0x22
MODINVD:DEFS	0x20
MODINVA:DEFS	2
MODINVUV:DEFS	2
	INCLUDE "align.asm"
PRODUCT:DEFS	0x40
	INCLUDE	"secp256k1tab.asm"
	INCLUDE "align.asm"
ECX:	DEFS	0x20
ECY:	DEFS	0x20
ECV:	DEFS	0x20
LAM:	DEFS	0x40
